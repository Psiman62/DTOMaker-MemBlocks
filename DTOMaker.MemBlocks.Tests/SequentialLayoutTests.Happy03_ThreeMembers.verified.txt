// <auto-generated>
// This file was generated by DTOMaker.MemBlocks.
// NuGet: https://www.nuget.org/packages/DTOMaker.MemBlocks
// Warning: Changes made to this file will be lost if re-generated.
// </auto-generated>
#pragma warning disable CS0414
#nullable enable
using DTOMaker.Runtime;
using System;
using System.Runtime.CompilerServices;
using System.Threading;
using System.Threading.Tasks;
namespace MyOrg.Models.MemBlocks
{
    public partial class MyDTO : IMyDTO, IFreezable
    {
        private const int BlockSize = 32;
        private readonly Memory<byte> _block;
        public ReadOnlyMemory<byte> Block => _block;
        public MyDTO() => _block = new byte[BlockSize];
        public MyDTO(ReadOnlySpan<byte> source) => _block = source.Slice(0, BlockSize).ToArray(); 
        // todo move to base
        private volatile bool _frozen;
        public bool IsFrozen() => _frozen;
        public IFreezable PartCopy() => new MyDTO(this);

        [MethodImpl(MethodImplOptions.NoInlining)]
        private void ThrowIsFrozenException(string? methodName) => throw new InvalidOperationException($"Cannot call {methodName} when frozen.");

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        private ref T IfNotFrozen<T>(ref T value, [CallerMemberName] string? methodName = null)
        {
            if (_frozen) ThrowIsFrozenException(methodName);
            return ref value;
        }

        public ValueTask FreezeAsync(IBlobStore store, CancellationToken cancellation)
        {
            if (_frozen) return default;
            _frozen = true;
            // todo freeze base
            // todo freeze model type refs
            return default;
        }

        public MyDTO(IMyDTO source, bool frozen = false)
        {
            _block = new byte[BlockSize];
            _frozen = frozen;
            // todo base ctor
            // todo freezable members
            this.Field1 = source.Field1;
            this.Field2 = source.Field2;
            this.Field3 = source.Field3;
        }

        // <field-map>
        //  Seq.  Off.  Len.  Type        Endian  Name
        //  ----  ----  ----  --------    ------  --------
        //     1     0     8  Double      Little  Field1
        //     2     8     1  Boolean     Little  Field2
        //     3    16     8  Int64       Little  Field3
        // </field-map>
        public Double Field1
        {
            get => DTOMaker.Runtime.Codec_Double_LE.ReadFromSpan(_block.Slice(0, 8).Span);
            set => DTOMaker.Runtime.Codec_Double_LE.WriteToSpan(_block.Slice(0, 8).Span, IfNotFrozen(ref value));
        }

        public Boolean Field2
        {
            get => DTOMaker.Runtime.Codec_Boolean_LE.ReadFromSpan(_block.Slice(8, 1).Span);
            set => DTOMaker.Runtime.Codec_Boolean_LE.WriteToSpan(_block.Slice(8, 1).Span, IfNotFrozen(ref value));
        }

        public Int64 Field3
        {
            get => DTOMaker.Runtime.Codec_Int64_LE.ReadFromSpan(_block.Slice(16, 8).Span);
            set => DTOMaker.Runtime.Codec_Int64_LE.WriteToSpan(_block.Slice(16, 8).Span, IfNotFrozen(ref value));
        }

    }
}
